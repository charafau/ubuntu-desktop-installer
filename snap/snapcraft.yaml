name: ubuntu-desktop-installer
version: git
summary: Ubuntu Desktop Installer
description: |
  This project is a modern implementation of the Ubuntu Desktop installer,
  using subiquity as a backend and Flutter for the UI.
grade: stable
confinement: classic
base: core20

architectures:
  - build-on: amd64

apps:
  ubuntu-desktop-installer:
    command: bin/ubuntu_desktop_installer
    environment:
      PATH: $SNAP/usr/bin:$SNAP/bin:$PATH
      LIBGL_DRIVERS_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/dri
      LD_LIBRARY_PATH: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/usr/lib/:$SNAP/lib
      LIBGL_ALWAYS_SOFTWARE: 1 # force software rendering for now

parts:
  flutter:
    plugin: nil
    # clone via override-build to preserve git meta
    override-build: |
      set -eux
      snapcraftctl build
      git clone -b dev https://github.com/flutter/flutter.git
      flutter/bin/flutter upgrade
      flutter/bin/flutter config --enable-linux-desktop
      flutter/bin/flutter doctor -v
      cp -r flutter $SNAPCRAFT_PART_INSTALL/
    build-packages:
      - curl
      - git
      - unzip
      - clang
      - cmake
      - ninja-build
      - pkg-config
      - libgtk-3-dev
      - liblzma-dev
    prime:
      - -flutter

  ubuntu-desktop-installer:
    after: [flutter]
    source: .
    plugin: nil
    override-build: |
      set -eux
      cd packages/subiquity_client
      $SNAPCRAFT_STAGE/flutter/bin/flutter pub get
      cd ../ubuntu_desktop_installer
      $SNAPCRAFT_STAGE/flutter/bin/flutter pub get
      $SNAPCRAFT_STAGE/flutter/bin/flutter build linux --release -v
      mkdir -p $SNAPCRAFT_PART_INSTALL/bin
      cp -r build/linux/x64/release/bundle/* $SNAPCRAFT_PART_INSTALL/bin/
    stage-packages:
      - libatk-bridge2.0-0
      - libatk1.0-0
      - libatspi2.0-0
      - libcairo-gobject2
      - libcairo2
      - libdatrie1
      - libepoxy0
      - libfontconfig1
      - libfreetype6
      - libfribidi0
      - libgdk-pixbuf2.0-0
      - libgraphite2-3
      - libgtk-3-0
      - libharfbuzz0b
      - libpango-1.0-0
      - libpangocairo-1.0-0
      - libpangoft2-1.0-0
      - libpixman-1-0
      - libpng16-16
      - libthai0
      - libwayland-client0
      - libwayland-cursor0
      - libwayland-egl1
      - libx11-6
      - libxau6
      - libxcb-render0
      - libxcb-shm0
      - libxcb1
      - libxcomposite1
      - libxcursor1
      - libxdamage1
      - libxdmcp6
      - libxext6
      - libxfixes3
      - libxi6
      - libxinerama1
      - libxkbcommon0
      - libxrandr2
      - libxrender1
